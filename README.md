# Описание системы

1. LOMS (Logistics and Order Management System) - сервис, отвечающий за учет заказов и логистику.
2. Checkout - сервис, отвечающий за корзину пользователя и оформление заказа.
3. Notifications - сервис, отвечающий за отправку уведомлений.
4. ProductService - внешний сервис, который предоставляет информацию о товарах.

### Путь покупки товаров
* Checkout.addToCart  
    * добавляем в корзину и проверяем, что есть в наличии)
* Можем удалять из корзины
* Можем получать список товаров корзины
    * название и цена тянутся из ProductService.get_product
* Приобретаем товары через Checkout.purchase
    * идем в LOMS.createOrder и создаем заказ
    * У заказа статус new
    * LOMS резервирует нужное количество единиц товара
    * Если не удалось зарезервить, заказ падает в статус failed
    * Если удалось, падаем в статус awaiting payment
* Оплачиваем заказ
    * Вызываем LOMS.orderPayed
    * Резервы переходят в списание товара со склада
    * Заказ идет в статус payed
* Можно отменить заказ до оплаты
    * Вызываем LOMS.cancelOrder
    * Все резервирования по заказу отменяются, товары снова доступны другим пользователям
    * Заказ переходит в статус cancelled
    * LOMS должен сам отменять заказы по таймауту, если не оплатили в течение 10 минут


## Схема баз данных
![db_scheme](https://github.com/deerc-dev/openedx-admin/assets/45228812/eeef8395-bdd9-4c0b-af70-2e05b0dcc0b5)

# Локальная разработка

1. В корневую папку необходимо добавить .env файл по аналогии с example.env, в котором указаны параметры подключения к базам данных микросервисом 
2. В папки checkout и loms необходимо добавить файлы config.yaml по аналогии с config.example.yaml 
3. Выполнить следующую комманду:
> docker-compose up --build

## Создание миграций
1. Чтобы выполнить миграцию баз данных, необходимо установить библиотеку goose:
> go install github.com/pressly/goose/v3/cmd/goose@latest

2. Перейти в папку migration соответствующего микросервиса и выполнить команду:
> goose create \*имя миграции\* sql

3. В терминале импортировать соответствующую переменную окружения:
> CH_POSTGRES_URL  # connection string для сервиса checkout  
> LOMS_POSTGRES_URL # connection string для сервиса loms

4. выполнить комманду:
> make migrate

